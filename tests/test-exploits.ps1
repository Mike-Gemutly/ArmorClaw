# ArmorClaw v1: Security Exploit Simulations (PowerShell)
# Simulates common attack vectors against the container
# Labels: EXPECTED_FAILURE (can't do it), EXPECTED_CONTAINMENT (works but contained), UNEXPECTED_SUCCESS (hard fail)

Write-Host "üß™ Security Exploit Simulations"
Write-Host "================================"
Write-Host ""

$ErrorActionPreference = "Continue"
$timestamp = [int][double]::Parse((Get-Date -UFormat %s))
$CONTAINER_NAME = "test-exploit-$timestamp"
$runCount = 0
$passCount = 0
$failCount = 0

# Helper to log test outcomes
function Log-Test {
    param(
        [string]$Label,
        [string]$Name,
        [bool]$Passed
    )

    $script:runCount++

    if ($Passed) {
        Write-Host "‚úÖ [$Label] $Name" -ForegroundColor Green
        $script:passCount++
    } else {
        Write-Host "‚ùå [$Label] $Name" -ForegroundColor Red
        $script:failCount++
    }
}

# Start container for exploitation tests
docker run -d --rm --name $CONTAINER_NAME `
    -e OPENAI_API_KEY="sk-test-exploit-$timestamp" `
    armorclaw/agent:v1 sleep infinity 2>&1 | Out-Null

Start-Sleep -Seconds 2

# Cleanup handler
$cleanup = {
    param($containerName)
    docker stop $containerName 2>$null | Out-Null
    docker rm $containerName 2>$null | Out-Null
}

Write-Host "--- Exploit Simulation Suite ---"
Write-Host ""

# ============================================================================
# Test Group 1: Shell Escape Attempts (EXPECTED_FAILURE)
# ============================================================================
Write-Host "Test Group 1: Shell Escape Attempts"
Write-Host "------------------------------------"

# Test 1.1: Try to execute sh directly
$shTest = docker exec $CONTAINER_NAME sh -c "whoami" 2>&1
if ($LASTEXITCODE -eq 0 -and $shTest -notmatch "not found") {
    Log-Test "UNEXPECTED_SUCCESS" "Shell escape via 'sh'" $false
} else {
    Log-Test "EXPECTED_FAILURE" "Shell escape via 'sh'" $true
}

# Test 1.2: Try to execute bash
$bashTest = docker exec $CONTAINER_NAME bash -c "whoami" 2>&1
if ($LASTEXITCODE -eq 0 -and $bashTest -notmatch "not found") {
    Log-Test "UNEXPECTED_SUCCESS" "Shell escape via 'bash'" $false
} else {
    Log-Test "EXPECTED_FAILURE" "Shell escape via 'bash'" $true
}

# Test 1.3: Try to exec shell from Python
$pyShellTest = docker exec $CONTAINER_NAME python -c "import os; os.execl('/bin/sh')" 2>&1
if ($pyShellTest -match "permission denied" -or $pyShellTest -match "no such file" -or $pyShellTest -match "OSError" -or $LASTEXITCODE -ne 0) {
    Log-Test "EXPECTED_FAILURE" "Shell escape via Python os.execl" $true
} else {
    Log-Test "UNEXPECTED_SUCCESS" "Shell escape via Python os.execl" $false
}

# Test 1.4: Try to exec shell from Node
$nodeShellTest = docker exec $CONTAINER_NAME node -e "require('child_process').exec('/bin/sh')" 2>&1
if ($nodeShellTest -match "not found" -or $nodeShellTest -match "EACCES" -or $LASTEXITCODE -ne 0) {
    Log-Test "EXPECTED_FAILURE" "Shell escape via Node child_process" $true
} else {
    Log-Test "UNEXPECTED_SUCCESS" "Shell escape via Node child_process" $false
}

Write-Host ""

# ============================================================================
# Test Group 2: Network Exfiltration Attempts (EXPECTED_FAILURE)
# ============================================================================
Write-Host "Test Group 2: Network Exfiltration Attempts"
Write-Host "--------------------------------------------"

# Test 2.1: Python urllib exfiltration
$pyNetTest = docker exec $CONTAINER_NAME python -c "import urllib.request; urllib.request.urlopen('http://httpbin.org/post')" 2>&1
if ($pyNetTest -match "connection refused" -or $pyNetTest -match "network unreachable" -or $pyNetTest -match "name resolution" -or $LASTEXITCODE -ne 0) {
    Log-Test "EXPECTED_FAILURE" "Network exfiltration via Python urllib" $true
} else {
    Log-Test "UNEXPECTED_SUCCESS" "Network exfiltration via Python urllib" $false
}

# Test 2.2: Node fetch exfiltration
$nodeNetTest = docker exec $CONTAINER_NAME node -e "fetch('http://httpbin.org/post')" 2>&1
if ($nodeNetTest -match "ECONNREFUSED" -or $nodeNetTest -match "ENETUNREACH" -or $nodeNetTest -match "not defined" -or $LASTEXITCODE -ne 0) {
    Log-Test "EXPECTED_FAILURE" "Network exfiltration via Node fetch" $true
} else {
    Log-Test "UNEXPECTED_SUCCESS" "Network exfiltration via Node fetch" $false
}

# Test 2.3: Try curl directly
$curlTest = docker exec $CONTAINER_NAME curl -s http://httpbin.org/post 2>&1
if ($curlTest -eq "" -or $curlTest -match "not found" -or $LASTEXITCODE -ne 0) {
    Log-Test "EXPECTED_FAILURE" "Network exfiltration via curl" $true
} else {
    Log-Test "UNEXPECTED_SUCCESS" "Network exfiltration via curl" $false
}

Write-Host ""

# ============================================================================
# Test Group 3: Filesystem Destruction Attempts (EXPECTED_CONTAINMENT)
# ============================================================================
Write-Host "Test Group 3: Filesystem Destruction (Containment = damage only inside container)"
Write-Host "---------------------------------------------------------------------------------------"

# Test 3.1: Try to delete all files in /tmp
$rmTest = docker exec $CONTAINER_NAME rm -rf /tmp 2>&1
# This may WORK but is contained (only affects /tmp inside container)
if ($LASTEXITCODE -eq 0) {
    Log-Test "EXPECTED_CONTAINMENT" "Destructive rm -rf /tmp (contained to container)" $true
} else {
    Log-Test "EXPECTED_FAILURE" "Destructive rm -rf /tmp" $true
}

# Test 3.2: Try to access host filesystem
$hostTest = docker exec $CONTAINER_NAME ls /host 2>&1
if ($LASTEXITCODE -eq 0) {
    Log-Test "UNEXPECTED_SUCCESS" "Host filesystem access via /host" $false
} else {
    Log-Test "EXPECTED_FAILURE" "Host filesystem access via /host" $true
}

# Test 3.3: Try to write to /etc (host-like location)
$etcWriteTest = docker exec $CONTAINER_NAME touch /etc/pwned 2>&1
# This may work in container but shouldn't affect host
if ($LASTEXITCODE -eq 0) {
    Log-Test "EXPECTED_CONTAINMENT" "Write to /etc (contained)" $true
} else {
    Log-Test "EXPECTED_FAILURE" "Write to /etc" $true
}

# Test 3.4: Try to access Docker socket
$dockerSocketTest = docker exec $CONTAINER_NAME ls /var/run/docker.sock 2>&1
if ($LASTEXITCODE -eq 0) {
    Log-Test "UNEXPECTED_SUCCESS" "Docker socket access (CRITICAL BREACH!)" $false
} else {
    Log-Test "EXPECTED_FAILURE" "Docker socket access" $true
}

Write-Host ""

# ============================================================================
# Test Group 4: Secret Exfiltration via Process Inspection (EXPECTED_CONTAINMENT)
# ============================================================================
Write-Host "Test Group 4: Process Secret Inspection (documented limitation)"
Write-Host "--------------------------------------------------------------------"

# Test 4.1: Read /proc/self/environ via Python
$procTest = docker exec $CONTAINER_NAME python -c "import os; print(open('/proc/self/environ').read()[:200])" 2>&1
if ($procTest -match "sk-test-exploit") {
    Log-Test "EXPECTED_CONTAINMENT" "Read /proc/self/environ via Python (can read own env, but can't escape)" $true
} else {
    Log-Test "UNEXPECTED_FAILURE" "Read /proc/self/environ via Python" $false
}

# Test 4.2: Try to use ps to see other processes
$psTest = docker exec $CONTAINER_NAME ps aux 2>&1
if ($LASTEXITCODE -eq 0 -and $psTest -notmatch "not found") {
    Log-Test "UNEXPECTED_SUCCESS" "Process listing via ps" $false
} else {
    Log-Test "EXPECTED_FAILURE" "Process listing via ps" $true
}

# Test 4.3: Try to use top for process monitoring
$topTest = docker exec $CONTAINER_NAME top -b -n1 2>&1
if ($LASTEXITCODE -eq 0 -and $topTest -notmatch "not found") {
    Log-Test "UNEXPECTED_SUCCESS" "Process monitoring via top" $false
} else {
    Log-Test "EXPECTED_FAILURE" "Process monitoring via top" $true
}

Write-Host ""

# ============================================================================
# Test Group 5: Privilege Escalation Attempts (EXPECTED_FAILURE)
# ============================================================================
Write-Host "Test Group 5: Privilege Escalation Attempts"
Write-Host "--------------------------------------------"

# Test 5.1: Check if running as root
$idTest = docker exec $CONTAINER_NAME id 2>&1
if ($idTest -match "uid=0") {
    Log-Test "UNEXPECTED_SUCCESS" "Running as root (CRITICAL!)" $false
} else {
    Log-Test "EXPECTED_FAILURE" "Running as root" $true
}

# Test 5.2: Check for sudo
$sudoTest = docker exec $CONTAINER_NAME which sudo 2>&1
if ($LASTEXITCODE -eq 0 -and $sudoTest -notmatch "not found") {
    Log-Test "UNEXPECTED_SUCCESS" "sudo command available" $false
} else {
    Log-Test "EXPECTED_FAILURE" "sudo command available" $true
}

# Test 5.3: Try to escalate via su
$suTest = docker exec $CONTAINER_NAME su 2>&1
if ($LASTEXITCODE -eq 0 -and $suTest -notmatch "not found" -and $suTest -notmatch "permission denied") {
    Log-Test "UNEXPECTED_SUCCESS" "su command works" $false
} else {
    Log-Test "EXPECTED_FAILURE" "su command works" $true
}

Write-Host ""

# ============================================================================
# Test Group 6: Dangerous Command Execution (EXPECTED_FAILURE)
# ============================================================================
Write-Host "Test Group 6: Dangerous Command Availability"
Write-Host "---------------------------------------------"

$dangerousCommands = @("rm", "mv", "find", "shred", "unlink", "nmap", "socat", "openssl", "dd")

foreach ($cmd in $dangerousCommands) {
    $cmdTest = docker exec $CONTAINER_NAME which $cmd 2>&1
    if ($LASTEXITCODE -eq 0 -and $cmdTest -notmatch "not found") {
        Log-Test "UNEXPECTED_SUCCESS" "Dangerous command available: $cmd" $false
    } else {
        Log-Test "EXPECTED_FAILURE" "Dangerous command available: $cmd" $true
    }
}

# Cleanup
& $cleanup $CONTAINER_NAME

# ============================================================================
# Summary
# ============================================================================
Write-Host ""
Write-Host "================================"
Write-Host "Exploit Simulation Summary"
Write-Host "================================"
Write-Host ""
Write-Host "Total Tests:  $runCount"
Write-Host "Passed:       $passCount"
Write-Host "Failed:       $failCount"
Write-Host ""

if ($failCount -eq 0) {
    Write-Host "‚úÖ ALL EXPLOIT TESTS PASSED" -ForegroundColor Green
    Write-Host ""
    Write-Host "Security posture verified:"
    Write-Host "  ‚úÖ No shell escape possible"
    Write-Host "  ‚úÖ No network exfiltration"
    Write-Host "  ‚úÖ No host filesystem access"
    Write-Host "  ‚úÖ No Docker socket exposure"
    Write-Host "  ‚úÖ No privilege escalation"
    Write-Host "  ‚úÖ Dangerous tools removed"
    Write-Host ""
    Write-Host "‚ö†Ô∏è  Documented limitations (expected):"
    Write-Host "  ‚úÖ Agent can read own /proc/self/environ (by design)"
    Write-Host "  ‚úÖ Agent can modify files inside container (contained)"
    Write-Host ""
    Write-Host "Blast radius = container memory only"
    exit 0
} else {
    Write-Host "‚ùå $failCount EXPLOIT TEST(S) FAILED" -ForegroundColor Red
    Write-Host ""
    Write-Host "CRITICAL: Unexpected security weaknesses detected!"
    exit 1
}
