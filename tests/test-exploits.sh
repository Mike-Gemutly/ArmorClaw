#!/bin/bash
set -euo pipefail

# ArmorClaw v1: Security Exploit Simulations
# Simulates common attack vectors against the container
# Labels: EXPECTED_FAILURE (can't do it), EXPECTED_CONTAINMENT (works but contained), UNEXPECTED_SUCCESS (hard fail)

echo "üß™ Security Exploit Simulations"
echo "================================"
echo ""

# Ensure container image exists (required for all exploit tests)
if ! docker images armorclaw/agent:v1 | grep -q armorclaw; then
    echo "‚ÑπÔ∏è  Container image not found. Building from Dockerfile..."
    if [ -f "Dockerfile" ]; then
        docker build -t armorclaw/agent:v1 .
        echo "‚úÖ Container image built successfully"
    else
        echo "‚ùå FAIL: No Dockerfile found"
        exit 1
    fi
fi

CONTAINER_NAME="test-exploit-$$"
RUN_COUNT=0
PASS_COUNT=0
FAIL_COUNT=0

# Helper to log test outcomes
log_test() {
    local label="$1"
    local name="$2"
    local result="$3"

    RUN_COUNT=$((RUN_COUNT + 1))

    if [ "$result" = "PASS" ]; then
        echo "‚úÖ [$label] $name"
        PASS_COUNT=$((PASS_COUNT + 1))
    else
        echo "‚ùå [$label] $name"
        FAIL_COUNT=$((FAIL_COUNT + 1))
    fi
}

# Start container for exploitation tests
# Apply same security options as bridge: seccomp profile + network isolation
# Note: Use Python for sleep since /bin/sh is removed in hardened image
docker run -d --rm --name $CONTAINER_NAME \
    --network=none \
    --security-opt seccomp=$(dirname "$0")/../container/seccomp-profile.json \
    --cap-drop=ALL \
    --read-only \
    -e OPENAI_API_KEY="sk-test-exploit-$(date +%s)" \
    armorclaw/agent:v1 python3 -c "import time; time.sleep(999999)" >/dev/null 2>&1

sleep 1

# Cleanup handler
cleanup() {
    docker stop $CONTAINER_NAME >/dev/null 2>&1 || true
    docker rm $CONTAINER_NAME >/dev/null 2>&1 || true
}
trap cleanup EXIT

echo "--- Exploit Simulation Suite ---"
echo ""

# ============================================================================
# TEST 1: Shell Escape Attempts (EXPECTED_FAILURE)
# ============================================================================
echo "Test Group 1: Shell Escape Attempts"
echo "------------------------------------"

# Test 1.1: Try to execute sh directly
if docker exec $CONTAINER_NAME sh -c "whoami" 2>/dev/null; then
    log_test "UNEXPECTED_SUCCESS" "Shell escape via 'sh'" "FAIL"
else
    log_test "EXPECTED_FAILURE" "Shell escape via 'sh'" "PASS"
fi

# Test 1.2: Try to execute bash
if docker exec $CONTAINER_NAME bash -c "whoami" 2>/dev/null; then
    log_test "UNEXPECTED_SUCCESS" "Shell escape via 'bash'" "FAIL"
else
    log_test "EXPECTED_FAILURE" "Shell escape via 'bash'" "PASS"
fi

# Test 1.3: Try to exec shell from Python
PY_SHELL_ESCAPE=$(docker exec $CONTAINER_NAME python -c "import os; os.execl('/bin/sh')" 2>&1 || true)
if echo "$PY_SHELL_ESCAPE" | grep -qi "permission denied\|no such file"; then
    log_test "EXPECTED_FAILURE" "Shell escape via Python os.execl" "PASS"
else
    log_test "UNEXPECTED_SUCCESS" "Shell escape via Python os.execl" "FAIL"
fi

# Test 1.4: Try to exec shell from Node
if docker exec $CONTAINER_NAME node -e "require('child_process').exec('/bin/sh')" 2>/dev/null; then
    log_test "UNEXPECTED_SUCCESS" "Shell escape via Node child_process" "FAIL"
else
    log_test "EXPECTED_FAILURE" "Shell escape via Node child_process" "PASS"
fi

echo ""

# ============================================================================
# TEST 2: Network Exfiltration Attempts (EXPECTED_FAILURE)
# ============================================================================
echo "Test Group 2: Network Exfiltration Attempts"
echo "--------------------------------------------"

# Test 2.1: Python urllib exfiltration
PY_NET_ATTEMPT=$(docker exec $CONTAINER_NAME python -c "import urllib.request; urllib.request.urlopen('http://httpbin.org/post')" 2>&1 || true)
if echo "$PY_NET_ATTEMPT" | grep -qi "connection refused\|network unreachable\|name resolution"; then
    log_test "EXPECTED_FAILURE" "Network exfiltration via Python urllib" "PASS"
else
    log_test "UNEXPECTED_SUCCESS" "Network exfiltration via Python urllib" "FAIL"
fi

# Test 2.2: Node fetch exfiltration
NODE_NET_ATTEMPT=$(docker exec $CONTAINER_NAME node -e "fetch('http://httpbin.org/post')" 2>&1 || true)
if echo "$NODE_NET_ATTEMPT" | grep -qi "ECONNREFUSED\ENETUNREACH\fetch is not defined"; then
    log_test "EXPECTED_FAILURE" "Network exfiltration via Node fetch" "PASS"
else
    log_test "UNEXPECTED_SUCCESS" "Network exfiltration via Node fetch" "FAIL"
fi

# Test 2.3: Try curl directly
if docker exec $CONTAINER_NAME curl -s http://httpbin.org/post 2>/dev/null; then
    log_test "UNEXPECTED_SUCCESS" "Network exfiltration via curl" "FAIL"
else
    log_test "EXPECTED_FAILURE" "Network exfiltration via curl" "PASS"
fi

echo ""

# ============================================================================
# TEST 3: Filesystem Destruction Attempts (EXPECTED_CONTAINMENT)
# ============================================================================
echo "Test Group 3: Filesystem Destruction (Containment = damage only inside container)"
echo "---------------------------------------------------------------------------------------"

# Test 3.1: Try to delete all files in /workspace
if docker exec $CONTAINER_NAME rm -rf /workspace 2>/dev/null; then
    # This WORKS but is contained (only affects /workspace inside container)
    log_test "EXPECTED_CONTAINMENT" "Destructive rm -rf /workspace (contained)" "PASS"
else
    log_test "EXPECTED_FAILURE" "Destructive rm -rf /workspace" "FAIL"
fi

# Test 3.2: Try to access host filesystem
if docker exec $CONTAINER_NAME ls /host 2>/dev/null; then
    log_test "UNEXPECTED_SUCCESS" "Host filesystem access via /host" "FAIL"
else
    log_test "EXPECTED_FAILURE" "Host filesystem access via /host" "PASS"
fi

# Test 3.3: Try to write to /etc (host-like location)
if docker exec $CONTAINER_NAME touch /etc/pwned 2>/dev/null; then
    # This may work in container but shouldn't affect host
    log_test "EXPECTED_CONTAINMENT" "Write to /etc (contained)" "PASS"
else
    log_test "EXPECTED_FAILURE" "Write to /etc" "PASS"
fi

# Test 3.4: Try to access Docker socket
if docker exec $CONTAINER_NAME ls /var/run/docker.sock 2>/dev/null; then
    log_test "UNEXPECTED_SUCCESS" "Docker socket access (CRITICAL BREACH!)" "FAIL"
else
    log_test "EXPECTED_FAILURE" "Docker socket access" "PASS"
fi

echo ""

# ============================================================================
# TEST 4: Secret Exfiltration via Process Inspection (EXPECTED_CONTAINMENT)
# ============================================================================
echo "Test Group 4: Process Secret Inspection (documented limitation)"
echo "--------------------------------------------------------------------"

# Test 4.1: Read /proc/self/environ via Python
PY_ENV_READ=$(docker exec $CONTAINER_NAME python -c "import os; print(open('/proc/self/environ').read()[:200])" 2>/dev/null || true)
if echo "$PY_ENV_READ" | grep -q "sk-test-exploit"; then
    log_test "EXPECTED_CONTAINMENT" "Read /proc/self/environ via Python (can read own env, but can't escape)" "PASS"
else
    log_test "UNEXPECTED_FAILURE" "Read /proc/self/environ via Python" "FAIL"
fi

# Test 4.2: Try to use ps to see other processes
if docker exec $CONTAINER_NAME ps aux 2>/dev/null | grep -v "grep"; then
    log_test "UNEXPECTED_SUCCESS" "Process listing via ps" "FAIL"
else
    log_test "EXPECTED_FAILURE" "Process listing via ps" "PASS"
fi

# Test 4.3: Try to use top for process monitoring
if docker exec $CONTAINER_NAME top -b -n1 2>/dev/null; then
    log_test "UNEXPECTED_SUCCESS" "Process monitoring via top" "FAIL"
else
    log_test "EXPECTED_FAILURE" "Process monitoring via top" "PASS"
fi

echo ""

# ============================================================================
# TEST 5: Privilege Escalation Attempts (EXPECTED_FAILURE)
# ============================================================================
echo "Test Group 5: Privilege Escalation Attempts"
echo "--------------------------------------------"

# Test 5.1: Check if running as root
if docker exec $CONTAINER_NAME id | grep -q "uid=0"; then
    log_test "UNEXPECTED_SUCCESS" "Running as root (CRITICAL!)" "FAIL"
else
    log_test "EXPECTED_FAILURE" "Running as root" "PASS"
fi

# Test 5.2: Check for sudo
if docker exec $CONTAINER_NAME which sudo 2>/dev/null; then
    log_test "UNEXPECTED_SUCCESS" "sudo command available" "FAIL"
else
    log_test "EXPECTED_FAILURE" "sudo command available" "PASS"
fi

# Test 5.3: Try to escalate via su
if docker exec $CONTAINER_NAME su 2>/dev/null; then
    log_test "UNEXPECTED_SUCCESS" "su command works" "FAIL"
else
    log_test "EXPECTED_FAILURE" "su command works" "PASS"
fi

echo ""

# ============================================================================
# TEST 6: Dangerous Command Execution (EXPECTED_FAILURE)
# ============================================================================
echo "Test Group 6: Dangerous Command Availability"
echo "---------------------------------------------"

DANGEROUS_CMNS="rm mv find shred unlink nmap socat openssl dd"

for cmd in $DANGEROUS_CMNS; do
    if docker exec $CONTAINER_NAME which "$cmd" 2>/dev/null; then
        log_test "UNEXPECTED_SUCCESS" "Dangerous command available: $cmd" "FAIL"
    else
        log_test "EXPECTED_FAILURE" "Dangerous command available: $cmd" "PASS"
    fi
done

echo ""

# ============================================================================
# SUMMARY
# ============================================================================
echo "================================"
echo "Exploit Simulation Summary"
echo "================================"
echo ""
echo "Total Tests:  $RUN_COUNT"
echo "Passed:       $PASS_COUNT"
echo "Failed:       $FAIL_COUNT"
echo ""

if [ $FAIL_COUNT -eq 0 ]; then
    echo "‚úÖ ALL EXPLOIT TESTS PASSED"
    echo ""
    echo "Security posture verified:"
    echo "  ‚úÖ No shell escape possible"
    echo "  ‚úÖ No network exfiltration"
    echo "  ‚úÖ No host filesystem access"
    echo "  ‚úÖ No Docker socket exposure"
    echo "  ‚úÖ No privilege escalation"
    echo "  ‚úÖ Dangerous tools removed"
    echo ""
    echo "‚ö†Ô∏è  Documented limitations (expected):"
    echo "  ‚úÖ Agent can read own /proc/self/environ (by design)"
    echo "  ‚úÖ Agent can modify files inside container (contained)"
    echo ""
    echo "Blast radius = container memory only"
    exit 0
else
    echo "‚ùå $FAIL_COUNT EXPLOIT TEST(S) FAILED"
    echo ""
    echo "CRITICAL: Unexpected security weaknesses detected!"
    exit 1
fi
