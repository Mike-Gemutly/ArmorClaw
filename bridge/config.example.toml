# ArmorClaw Bridge Configuration Example
#
# This file contains all available configuration options for the ArmorClaw bridge.
# Copy this file to ~/.armorclaw/config.toml or /etc/armorclaw/config.toml
# and customize it for your environment.
#
# Configuration precedence (highest to lowest):
# 1. Environment variables (ARMORCLAW_*)
# 2. Configuration file
# 3. Built-in defaults

[server]
# Path to the Unix domain socket for JSON-RPC communication
socket_path = "/run/armorclaw/bridge.sock"

# Path to the PID file for daemon mode
pid_file = "/run/armorclaw/bridge.pid"

# Run as a background daemon
daemonize = false

[keystore]
# Path to the encrypted keystore database
# The database is encrypted using SQLCipher with a hardware-derived master key
db_path = "~/.armorclaw/keystore.db"

# Optional: Override the hardware-derived master key
# WARNING: If set, the database will only be accessible with this key
# For production use, leave this empty to use hardware-derived keys
master_key = ""

[matrix]
# Enable Matrix communication
enabled = false

# Matrix homeserver URL
homeserver_url = "https://matrix.example.com"

# Matrix username for auto-login
username = "bridge-bot"

# Matrix password for auto-login
password = "change-me"

# Device ID for the Matrix client
device_id = "armorclaw-bridge"

# Sync interval in seconds
sync_interval = 5

# Rooms to automatically join on login
auto_rooms = []

[matrix.retry]
# Maximum number of retry attempts for Matrix operations
max_retries = 3

# Delay between retries in seconds
retry_delay = 5

# Backoff multiplier (each retry waits longer)
backoff_multiplier = 2.0

[logging]
# Log level: debug, info, warn, error
# Security events are always logged at INFO level regardless of this setting
level = "info"

# Log format: text, json
# Use "json" for structured logging with machine-parseable security events
# Recommended for production environments with log aggregation systems
format = "json"

# Log output: stdout, stderr, or absolute file path
# Use file output for persistent logs and audit trails
output = "/var/log/armorclaw/bridge.log"

# Examples:
# 1. Console logging with JSON format (development):
#    format = "json"
#    output = "stdout"
#
# 2. File logging with structured format (production):
#    format = "json"
#    output = "/var/log/armorclaw/bridge.log"
#
# 3. Simple text logging (local testing):
#    format = "text"
#    output = "stdout"
#
# Security events include:
# - auth_attempt, auth_success, auth_failure, auth_rejected
# - container_start, container_stop, container_error, container_timeout
# - secret_access, secret_inject, secret_cleanup
# - access_denied, access_granted
# - pii_detected, pii_redacted
# - budget_warning, budget_exceeded
# - hitl_required, hitl_approved, hitl_rejected, hitl_timeout
#
# All security events include:
# - timestamp (UTC, RFC3339)
# - level (debug, info, warn, error)
# - component (bridge, rpc, matrix, security)
# - event_type (one of the security events listed above)
# - service (armorclaw)
# - version (bridge version)
# - context-specific fields (session_id, container_id, key_id, etc.)

[webrtc]
# Enable WebRTC voice call support
enabled = false

[webrtc.signaling]
# WebSocket server address for WebRTC signaling
listen_address = "0.0.0.0:8443"

# WebSocket path for signaling connections
path = "/webrtc"

# TLS certificate for secure WebSocket (wss://)
# Leave empty to use unencrypted WebSocket (not recommended for production)
tls_cert = "/etc/armorclaw/cert.pem"
tls_key = "/etc/armorclaw/key.pem"

[webrtc.session]
# Default session TTL (time-to-live)
# Valid units: s (seconds), m (minutes), h (hours)
default_ttl = "10m"

# Maximum allowed TTL
max_ttl = "1h"

# How often to check for expired sessions
cleanup_interval = "1m"

[webrtc.turn]
# TURN server configuration for NAT traversal
enabled = true

# TURN server address
server = "turn:matrix.armorclaw.com:3478"

# STUN server address
stun_server = "stun:matrix.armorclaw.com:3478"

[webrtc.media]
# Audio configuration
sample_rate = 48000  # Audio sample rate in Hz
channels = 1         # Number of audio channels (1 = mono, 2 = stereo)
bitrate = 64000      # Target bitrate in bps
payload_type = 111   # RTP payload type for Opus codec

[webrtc.security]
# Call session token secret for HMAC generation
# In production, use a strong random secret (32+ bytes)
token_secret = "change-me-to-a-strong-random-secret"

# Token TTL (should be shorter than session TTL for security)
token_ttl = "15m"

[voice]
# Enable Matrix voice call support
enabled = false

[voice.general]
# Default call lifetime (time-to-live)
# Valid units: s (seconds), m (minutes), h (hours)
default_lifetime = "30m"

# Maximum call lifetime (hard limit)
max_lifetime = "2h"

# Automatically answer incoming calls
auto_answer = false

# Require the bridge to be a member of the room for calls
require_membership = true

# Maximum number of concurrent calls allowed
# Set to 0 for unlimited (not recommended for production)
max_concurrent_calls = 5

# Default token limit per call (number of API operations)
# 1 token ~= 1 second of audio processing
default_token_limit = 3600  # ~1 hour at default rate

# Default duration limit per call
default_duration_limit = "1h"

# Warning threshold (percentage of budget used)
# Example: 0.8 = warn when 80% of budget is used
warning_threshold = 0.8

# Hard stop when budget is exceeded (true = terminate call immediately)
hard_stop = false

[voice.rooms]
# Room access control - specify rooms by Matrix room ID
# Leave empty to allow calls from any room (not recommended)

# Allowed rooms (whitelist)
# Calls only accepted from these rooms
allowed = []

# Blocked rooms (blacklist)
# Calls rejected from these rooms
blocked = []

[voice.security]
# Voice call security policies

# Require end-to-end encryption for voice calls
require_e2ee = true

# Minimum E2EE encryption algorithm
# Options: "olm.v1.curve25519-aes-sha2", "megolm.v1.aes-sha2"
min_e2ee_algorithm = "megolm.v1.aes-sha2"

# Rate limiting (calls per minute per user)
rate_limit = 10

# Rate limiting burst size (temporary allowance)
rate_limit_burst = 20

# Require explicit user approval for new callers
require_approval = false

# Approval timeout (how long to wait for approval)
approval_timeout = "5m"

# Audit all voice calls (log to security audit trail)
audit_calls = true

# Maximum call participants (1 = direct call only)
max_participants = 2

[voice.budget]
# Voice call budget enforcement

# Enable budget tracking
enabled = true

# Global token limit for all voice calls
# Set to 0 to use per-call limits only
global_token_limit = 0

# Global duration limit for all voice calls
# Valid units: s (seconds), m (minutes), h (hours)
global_duration_limit = "0s"  # 0 = unlimited

# Budget enforcement interval
# How often to check budget limits
enforcement_interval = "30s"

[voice.ttl]
# Session TTL (time-to-live) management

# Default session TTL
# Valid units: s (seconds), m (minutes), h (hours)
default_ttl = "30m"

# Maximum allowed TTL
# Prevents callers from requesting excessively long sessions
max_ttl = "2h"

# TTL enforcement interval
# How often to check for expired sessions
enforcement_interval = "1m"

# Enable TTL warnings
# Log warnings when sessions are approaching expiration
warn_before_expiration = "5m"

# Action on TTL expiration
# Options: "terminate", "warn", "extend"
on_expiration = "terminate"

[notifications]
# Notification system configuration

# Admin room ID for receiving system notifications
# Notifications will be sent to this Matrix room
admin_room_id = ""

# Enable notifications (requires Matrix to be enabled)
enabled = false

# Alert threshold (percentage of budget used)
# Example: 0.8 = send alerts when 80% of budget is used
alert_threshold = 0.8

[eventbus]
# Event bus for real-time Matrix event push
# This replaces polling for Matrix events in containers

# Enable WebSocket server for event push
# Containers can subscribe to real-time Matrix events via WebSocket
websocket_enabled = false

# WebSocket listen address (e.g., "0.0.0.0:8444")
websocket_addr = "0.0.0.0:8444"

# WebSocket path for event subscriptions
websocket_path = "/events"

# Maximum concurrent subscribers
# Prevents resource exhaustion from too many connections
max_subscribers = 100

# Inactivity timeout for subscribers
# Valid units: s (seconds), m (minutes), h (hours)
# Subscribers inactive for this long are disconnected
inactivity_timeout = "30m"

[webrtc.signaling]
# WebRTC signaling server configuration

# Enable WebSocket signaling server for WebRTC
# This provides real-time signaling for browser clients
enabled = false

# WebSocket listen address (e.g., "0.0.0.0:8443")
addr = "0.0.0.0:8443"

# WebSocket path (e.g., "/webrtc")
path = "/webrtc"

# TLS certificate file (optional, for wss://)
tls_cert = ""

# TLS key file (optional, for wss://)
tls_key = ""
