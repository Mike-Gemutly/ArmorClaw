# Matrix Synapse Configuration for ArmorClaw
# Production-ready configuration with E2EE enforcement

# ========================================
# SERVER SETTINGS
# ========================================
server_name: "${MATRIX_SERVER_NAME}"
pid_file: /data/homeserver.pid
web_client: false
public_baseurl: "https://${MATRIX_SERVER_NAME}"

# ========================================
# LISTENERS
# ========================================
listeners:
  # Client API
  - port: 8008
    tls: false
    type: http
    x_forwarded: true
    bind_addresses: ['0.0.0.0']
    resources:
      - names: [client, federation]
        compress: false

  # Federation API
  - port: 8448
    tls: false
    type: http
    x_forwarded: true
    bind_addresses: ['0.0.0.0']
    resources:
      - names: [federation]
        compress: false

# ========================================
# DATABASE (PostgreSQL)
# ========================================
database:
  name: psycopg2
  args:
    user: ${POSTGRES_USER}
    password: ${POSTGRES_PASSWORD}
    database: ${POSTGRES_DB}
    host: postgres
    port: 5432
    cp_min: 5
    cp_max: 20

# ========================================
# REGISTRATION & AUTHENTICATION
# ========================================
enable_registration: false
registration_shared_secret: "${REGISTRATION_SHARED_SECRET}"

# Registration tokens (recommended)
registration_requires_token: true
allow_guest_access: false

# Password policy
password_config:
  enabled: true
  minimum_length: 12
  require_digit: true
  require_lowercase: true
  require_uppercase: true
  require_symbol: true

# ========================================
# E2EE ENFORCEMENT
# ========================================
# Force encryption for new rooms
encryption_enabled_by_default_for_room_type: all

# Require cross-signing
ui_auth:
  session_timeout: "30s"

# E2EE default settings
default_room_version: "10"

# ========================================
# FEDERATION
# ========================================
federation_domain_whitelist: []  # Empty = allow all
federation_client_minimum_tls_version: "1.2"

# Trusted key servers
trusted_key_servers:
  - server_name: "matrix.org"
    verify_keys:
      "ed25519:auto": "Noi6WqcDj0QmPxCNQqgezwTlBKrfqehM1W1eE4H1u9U"

# Prevent federation with homeservers
federation_rc_reject_limit: 50
federation_rc_sleep_limit: 10
federation_rc_concurrent: 3

# ========================================
# RATE LIMITING
# ========================================
rc_message:
  per_second: 0.5
  burst_count: 20

rc_registration:
  per_second: 0.1
  burst_count: 3

rc_login:
  address:
    per_second: 0.1
    burst_count: 5
  account:
    per_second: 0.1
    burst_count: 5
  failed_attempts:
    per_second: 0.1
    burst_count: 3

rc_joins:
  local:
    per_second: 0.1
    burst_count: 20
  remote:
    per_second: 0.01
    burst_count: 10

rc_invites:
  per_room:
    per_second: 0.1
    burst_count: 10
  per_user:
    per_second: 0.1
    burst_count: 10

# ========================================
# MEDIA
# ========================================
media_store_path: "/data/media"
uploads_path: "/data/uploads"
max_upload_size: "50M"
max_image_pixels: "32M"

# URL previews
url_preview_enabled: true
url_preview_ip_range_blacklist:
  - '127.0.0.0/8'
  - '10.0.0.0/8'
  - '172.16.0.0/12'
  - '192.168.0.0/16'
  - '100.64.0.0/10'
  - '169.254.0.0/16'
  - '::1/128'
  - 'fe80::/64'
  - 'fc00::/7'

# ========================================
# LOGGING
# ========================================
log_config: "/data/log.config"

# ========================================
# METRICS & MONITORING
# ========================================
enable_metrics: true
metrics_port: 9092

# Sentry (optional)
# sentry_dsn: ""

# ========================================
# APPSERVICES (Bridge Integration)
# ========================================
# app_service_config_files:
#   - /data/appservices/bridge.yaml

# ========================================
# ROOM DIRECTORY
# ========================================
room_list_publication_rules:
  - action: allow
    condition:
      room_id: "*"
    reason: "Public rooms visible by default"

# ========================================
# RETENTION (Data Lifecycle)
# ========================================
retention:
  enabled: true
  default_min_lifetime: 1d
  allowed_lifetime_min: 1d
  allowed_lifetime_max: 365d
  purge_jobs:
    - longest_max_lifetime: 3d
      interval: 12h
    - longest_max_lifetime: 7d
      interval: 1d

# ========================================
# PUSH NOTIFICATIONS
# ========================================
push:
  enabled: true

# ========================================
# SECURITY
# ========================================
# Sign keys
signing_key_path: "/data/signing.key"
old_signing_keys: {}

# Key validity
key_refresh_interval: "1d"

# MAC validity for appservices
macaroon_secret_key: "${MACAROON_SECRET}"

# Form secret
form_secret: "${FORM_SECRET}"

# ========================================
# EMAIL (Optional)
# ========================================
# email:
#   smtp_host: "smtp.example.com"
#   smtp_port: 587
#   smtp_user: "noreply@example.com"
#   smtp_pass: "password"
#   require_transport_security: true
#   notif_from: "ArmorClaw Matrix <noreply@${MATRIX_SERVER_NAME}>"

# ========================================
# USER DIRECTORY
# ========================================
user_directory:
  enabled: true
  search_all_users: false  # Privacy: only search shared rooms

# ========================================
# SPAM CHECKING
# ========================================
spam_checker:
  module: "synapse.spam_checker_api.MjolnirSpamChecker"
  config:
    mjolnir_antispam_enabled: true

# ========================================
# THIRD PARTY RULES (Enterprise)
# ========================================
# third_party_event_rules:
#   module: "custom_rules.ArmorClawRules"
#   config: {}
